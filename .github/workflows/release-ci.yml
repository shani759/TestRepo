name: Release Cutoff Enforcement and Notification

on:
  push:
    branches:
      - 'release/*'

jobs:
  release-cutoff-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Python and dependencies
        run: pip install pyyaml

      - name: Write cutoff script
        run: |
          cat << 'EOF' > cutoff_script.py
          import os
          import yaml
          
          branch = os.environ.get('BRANCH_NAME')
          try:
              with open('.release_config.yml', 'r') as f:
                  config = yaml.safe_load(f)
              cutoff = config['releases'].get(branch, {}).get('cutoff', None)
          except Exception as e:
              cutoff = None
          
          if cutoff:
              print(f'cutoff={cutoff}')
          else:
              print('cutoff=9999-99-99')
          EOF

      - name: Read cutoff from metadata file
        id: cutoff
        run: |
          output=$(python cutoff_script.py)
          echo "$output" >> $GITHUB_OUTPUT
        env:
          BRANCH_NAME: ${{ github.ref_name }}

      - name: Check cutoff and set result
        id: check
        run: |
          NOW=$(date +%Y-%m-%d)
          CUTOFF="${{ steps.cutoff.outputs.cutoff }}"
          echo "Current date: $NOW"
          echo "Cutoff date: $CUTOFF"
          if [ "$CUTOFF" == "9999-99-99" ]; then
            echo "notify=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          if [[ "$NOW" > "$CUTOFF" ]]; then
            echo "notify=true" >> $GITHUB_OUTPUT
            echo "CI/CD blocked: commit after cutoff $CUTOFF."
            exit 1
          else
            echo "notify=false" >> $GITHUB_OUTPUT
            echo "CI/CD allowed: commit before cutoff $CUTOFF."
          fi

      - name: Create blocking issue when CI/CD is blocked
        if: failure() && steps.check.outputs.notify == 'true'
        uses: dacbd/create-issue-action@main
        with:
          token: ${{ github.token }}
          title: "üö´ CI/CD Blocked: Release Branch Past Cutoff (${{ github.ref_name }})"
          body: |
            ## üö´ CI/CD Blocked - Release Branch Past Cutoff
            
            **‚ö†Ô∏è AUTOMATIC BLOCK TRIGGERED**
            
            ### Details
            - **Branch:** `${{ github.ref_name }}`
            - **Cutoff Date:** `${{ steps.cutoff.outputs.cutoff }}`
            - **Current Date:** `$(date +%Y-%m-%d)`
            - **Commit SHA:** `${{ github.sha }}`
            - **Author:** `@${{ github.actor }}`
            - **Triggered by:** [Workflow Run #${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ### What Happened?
            A commit was pushed to release branch `${{ github.ref_name }}` after the established cutoff date of **${{ steps.cutoff.outputs.cutoff }}**.
            
            The CI/CD pipeline has been **automatically blocked** to prevent uncontrolled changes to this release.
            
            ### Required Actions
            - [ ] **Review the urgency** of this commit with the release manager
            - [ ] **Get approval** from stakeholders for post-cutoff changes
            - [ ] **Verify impact** on release timeline and stability
            - [ ] **Update cutoff date** in `.release_config.yml` if needed (emergency only)
            - [ ] **Close this issue** once resolved
            
            ### Emergency Override
            If this is a critical hotfix, update the cutoff date in `.release_config.yml`:
            ```yaml
            releases:
              ${{ github.ref_name }}:
                cutoff: "NEW_DATE_HERE"  # Format: YYYY-MM-DD
            ```
            
            ---
            _This issue was automatically created by the Release Cutoff Enforcement workflow._
          assignees: |
            shani759
          labels: |
            release-cutoff
            blocked
            urgent

      - name: Add comment to triggering commit
        if: failure() && steps.check.outputs.notify == 'true'
        uses: peter-evans/commit-comment@v3
        with:
          token: ${{ github.token }}
          sha: ${{ github.sha }}
          body: |
            üö´ **CI/CD BLOCKED** - This commit was made after the release cutoff date (**${{ steps.cutoff.outputs.cutoff }}**).
            
            A [blocking issue has been created](https://github.com/${{ github.repository }}/issues) for review.
            
            Please contact the release manager before proceeding.

      - name: Run CI/CD steps
        if: success()
        run: echo "Running CI/CD for release branch."
